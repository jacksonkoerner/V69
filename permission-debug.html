<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Permission Debug - FieldVoice Pro</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png">
    <meta name="theme-color" content="#0a1628">

    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FieldVoice">

    <link rel="stylesheet" href="./css/output.css">
    <script src="./js/pwa-utils.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 12px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        .log-entry { padding: 4px 8px; border-left: 3px solid transparent; margin: 2px 0; }
        .log-info { border-left-color: #3b82f6; background: #eff6ff; }
        .log-success { border-left-color: #16a34a; background: #f0fdf4; }
        .log-error { border-left-color: #dc2626; background: #fef2f2; }
        .log-warn { border-left-color: #f59e0b; background: #fffbeb; }
        .status-pass { background: #16a34a; color: white; }
        .status-fail { background: #dc2626; color: white; }
        .status-warn { background: #f59e0b; color: white; }
        .status-unknown { background: #64748b; color: white; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <!-- Header -->
    <header class="bg-red-600 text-white p-4 text-center">
        <h1 class="text-lg font-bold"><i class="fas fa-bug mr-2"></i>PERMISSION DEBUG PAGE</h1>
        <p class="text-xs text-red-200 mt-1">Diagnose why native iOS permission dialogs aren't appearing</p>
    </header>

    <main class="max-w-2xl mx-auto p-4 space-y-4">

        <!-- ==================== CRITICAL ALERT ==================== -->
        <div id="critical-alert" class="hidden bg-red-900 border-2 border-red-500 p-4 rounded">
            <p class="text-red-300 font-bold text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>CRITICAL ISSUE DETECTED</p>
            <p id="critical-alert-message" class="text-red-100 mt-2"></p>
            <p id="critical-alert-fix" class="text-yellow-300 mt-2 text-xs"></p>
        </div>

        <!-- ==================== QUICK DIAGNOSTICS ==================== -->
        <div class="bg-slate-800 border border-slate-700 rounded overflow-hidden">
            <div class="bg-slate-700 p-3 flex items-center justify-between">
                <span class="font-bold text-sm"><i class="fas fa-stethoscope mr-2"></i>QUICK DIAGNOSTICS</span>
                <button onclick="runFullDiagnostics()" class="px-3 py-1 bg-dot-orange hover:bg-orange-700 text-white text-xs font-bold rounded">
                    RUN ALL CHECKS
                </button>
            </div>
            <div id="quick-diagnostics" class="p-4">
                <p class="text-slate-400 text-xs">Click "RUN ALL CHECKS" to diagnose your environment</p>
            </div>
        </div>

        <!-- ==================== ENVIRONMENT DETECTION ==================== -->
        <div class="bg-slate-800 border border-slate-700 rounded overflow-hidden">
            <div class="bg-slate-700 p-3">
                <span class="font-bold text-sm"><i class="fas fa-microchip mr-2"></i>ENVIRONMENT DETECTION</span>
            </div>
            <div id="env-panel" class="p-4 space-y-2">
                <p class="text-slate-400 text-xs">Loading...</p>
            </div>
        </div>

        <!-- ==================== PERMISSION STATES ==================== -->
        <div class="bg-slate-800 border border-slate-700 rounded overflow-hidden">
            <div class="bg-slate-700 p-3 flex items-center justify-between">
                <span class="font-bold text-sm"><i class="fas fa-key mr-2"></i>PERMISSION STATES (via Permissions API)</span>
                <button onclick="checkPermissionStates()" class="px-3 py-1 bg-dot-blue hover:bg-blue-700 text-white text-xs font-bold rounded">
                    CHECK
                </button>
            </div>
            <div id="permission-states" class="p-4">
                <p class="text-slate-400 text-xs">Click "CHECK" to query current permission states</p>
            </div>
        </div>

        <!-- ==================== MICROPHONE TEST ==================== -->
        <div class="bg-slate-800 border border-slate-700 rounded overflow-hidden">
            <div class="bg-dot-navy p-3 flex items-center justify-between">
                <span class="font-bold text-sm text-dot-yellow"><i class="fas fa-microphone mr-2"></i>MICROPHONE TEST</span>
                <button onclick="testMicrophone()" class="px-4 py-2 bg-dot-yellow hover:bg-yellow-600 text-dot-navy text-xs font-bold rounded">
                    <i class="fas fa-play mr-1"></i>TEST NOW
                </button>
            </div>
            <div id="mic-log" class="p-3 max-h-64 overflow-y-auto bg-slate-900">
                <p class="text-slate-500 text-xs">Click "TEST NOW" to request microphone permission</p>
            </div>
        </div>

        <!-- ==================== CAMERA TEST ==================== -->
        <div class="bg-slate-800 border border-slate-700 rounded overflow-hidden">
            <div class="bg-dot-orange p-3 flex items-center justify-between">
                <span class="font-bold text-sm text-white"><i class="fas fa-camera mr-2"></i>CAMERA TEST</span>
                <button onclick="testCamera()" class="px-4 py-2 bg-white hover:bg-slate-100 text-dot-orange text-xs font-bold rounded">
                    <i class="fas fa-play mr-1"></i>TEST NOW
                </button>
            </div>
            <div id="cam-log" class="p-3 max-h-64 overflow-y-auto bg-slate-900">
                <p class="text-slate-500 text-xs">Click "TEST NOW" to request camera permission</p>
            </div>
        </div>

        <!-- ==================== LOCATION TEST ==================== -->
        <div class="bg-slate-800 border border-slate-700 rounded overflow-hidden">
            <div class="bg-safety-green p-3 flex items-center justify-between">
                <span class="font-bold text-sm text-white"><i class="fas fa-location-dot mr-2"></i>LOCATION TEST</span>
                <button onclick="testLocation()" class="px-4 py-2 bg-white hover:bg-slate-100 text-safety-green text-xs font-bold rounded">
                    <i class="fas fa-play mr-1"></i>TEST NOW
                </button>
            </div>
            <div id="loc-log" class="p-3 max-h-64 overflow-y-auto bg-slate-900">
                <p class="text-slate-500 text-xs">Click "TEST NOW" to request location permission</p>
            </div>
        </div>

        <!-- ==================== SPEECH RECOGNITION TEST ==================== -->
        <div class="bg-slate-800 border border-slate-700 rounded overflow-hidden">
            <div class="bg-violet-600 p-3 flex items-center justify-between">
                <span class="font-bold text-sm text-white"><i class="fas fa-comment-dots mr-2"></i>SPEECH RECOGNITION TEST</span>
                <button onclick="testSpeechRecognition()" class="px-4 py-2 bg-white hover:bg-slate-100 text-violet-600 text-xs font-bold rounded">
                    <i class="fas fa-play mr-1"></i>TEST NOW
                </button>
            </div>
            <div id="speech-log" class="p-3 max-h-64 overflow-y-auto bg-slate-900">
                <p class="text-slate-500 text-xs">Click "TEST NOW" to test speech recognition</p>
            </div>
        </div>

        <!-- ==================== RESET INSTRUCTIONS ==================== -->
        <div class="bg-amber-900/50 border border-amber-600 rounded overflow-hidden">
            <div class="bg-amber-700 p-3">
                <span class="font-bold text-sm text-white"><i class="fas fa-undo mr-2"></i>HOW TO RESET PERMISSIONS</span>
            </div>
            <div class="p-4 space-y-4 text-xs">
                <!-- PWA Warning -->
                <div class="bg-red-900/50 border border-red-500 p-3 rounded">
                    <p class="text-red-300 font-bold"><i class="fas fa-exclamation-triangle mr-1"></i>CRITICAL: PWA / Home Screen Mode</p>
                    <p class="text-red-200 mt-2">
                        <strong>If you added this site to your home screen, getUserMedia will NOT work!</strong><br>
                        iOS blocks camera/microphone access in standalone PWA mode.
                    </p>
                    <p class="text-yellow-300 mt-2">
                        <strong>FIX:</strong> Open this site in Safari browser directly, not from home screen.
                    </p>
                </div>

                <!-- Option 1 -->
                <div class="bg-slate-800 p-3 rounded">
                    <p class="font-bold text-amber-300 mb-2">Option 1: Reset Per-Site Permissions (Fastest)</p>
                    <ol class="text-slate-300 space-y-1 list-decimal list-inside">
                        <li>In Safari, tap the <strong class="text-white">aA</strong> button in the URL bar</li>
                        <li>Tap <strong class="text-white">Website Settings</strong></li>
                        <li>Set Camera, Microphone, Location to <strong class="text-white">Ask</strong></li>
                        <li>Reload the page</li>
                    </ol>
                </div>

                <!-- Option 2 -->
                <div class="bg-slate-800 p-3 rounded">
                    <p class="font-bold text-amber-300 mb-2">Option 2: Test in Private Browsing (Fresh State)</p>
                    <ol class="text-slate-300 space-y-1 list-decimal list-inside">
                        <li>Open Safari</li>
                        <li>Tap the tabs button (bottom right)</li>
                        <li>Tap <strong class="text-white">Private</strong></li>
                        <li>Navigate to this page</li>
                        <li>Permissions should prompt fresh</li>
                    </ol>
                </div>

                <!-- Option 3 -->
                <div class="bg-slate-800 p-3 rounded">
                    <p class="font-bold text-amber-300 mb-2">Option 3: Clear All Safari Data (Nuclear Option)</p>
                    <ol class="text-slate-300 space-y-1 list-decimal list-inside">
                        <li>Open iOS <strong class="text-white">Settings</strong></li>
                        <li>Scroll down and tap <strong class="text-white">Apps</strong></li>
                        <li>Tap <strong class="text-white">Safari</strong></li>
                        <li>Tap <strong class="text-white">Clear History and Website Data</strong></li>
                        <li>Return to this page and try again</li>
                    </ol>
                </div>

                <!-- iOS Settings -->
                <div class="bg-slate-800 p-3 rounded">
                    <p class="font-bold text-amber-300 mb-2">Option 4: Check iOS System Settings</p>
                    <p class="text-slate-300 mb-2">If permissions were denied at the iOS level:</p>
                    <ul class="text-slate-300 space-y-1 list-disc list-inside">
                        <li><strong class="text-white">Location:</strong> Settings > Privacy & Security > Location Services > Safari Websites</li>
                        <li><strong class="text-white">Camera:</strong> Settings > Privacy & Security > Camera > Safari</li>
                        <li><strong class="text-white">Microphone:</strong> Settings > Privacy & Security > Microphone > Safari</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ==================== RAW CONSOLE OUTPUT ==================== -->
        <div class="bg-slate-800 border border-slate-700 rounded overflow-hidden">
            <div class="bg-slate-700 p-3 flex items-center justify-between">
                <span class="font-bold text-sm"><i class="fas fa-terminal mr-2"></i>RAW CONSOLE OUTPUT</span>
                <div class="space-x-2">
                    <button onclick="copyConsole()" class="px-3 py-1 bg-slate-600 hover:bg-slate-500 text-white text-xs font-bold rounded">
                        <i class="fas fa-copy mr-1"></i>COPY
                    </button>
                    <button onclick="clearConsole()" class="px-3 py-1 bg-slate-600 hover:bg-slate-500 text-white text-xs font-bold rounded">
                        <i class="fas fa-trash mr-1"></i>CLEAR
                    </button>
                </div>
            </div>
            <div id="raw-console" class="p-3 max-h-96 overflow-y-auto bg-black text-green-400 font-mono text-xs">
                <p>// Console initialized</p>
                <p>// Run tests to see output</p>
            </div>
        </div>

        <!-- Back Link -->
        <div class="text-center py-4">
            <a href="permissions.html" class="text-dot-orange underline text-sm">
                <i class="fas fa-arrow-left mr-1"></i>Back to Permissions Setup
            </a>
        </div>

    </main>

    <script src="./js/permission-debug/main.js"></script>

    <!-- Offline Banner -->
    <div id="offline-banner" class="fixed top-0 left-0 right-0 bg-yellow-500 text-yellow-900 text-center py-2 px-4 font-bold text-sm z-[9999] transform -translate-y-full transition-transform duration-300" style="display: none;">
        <i class="fas fa-wifi-slash mr-2"></i>You are offline - Some features may be unavailable
    </div>

</body>
</html>
