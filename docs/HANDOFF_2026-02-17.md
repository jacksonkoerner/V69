# HANDOFF: FieldVoice Pro V69 ‚Äî Data Architecture Overhaul
**Date:** 2026-02-17  
**From:** George (evening session)  
**Priority:** CRITICAL ‚Äî core data layer is broken, needs clean redesign before feature work

---

## 1. What Happened Tonight

### Xcode 26.3 Setup ‚úÖ
- Xcode 26.3 RC installed at /Applications/Xcode.app (old 26.2 at /Applications/Xcode_26.2_old.app)
- Claude Agent (Opus 4.6) + Codex (GPT-5.3) configured in Xcode Intelligence
- MCP bridge connected: `xcrun mcpbridge`
- iOS project: `~/projects/V69/ios/App/App.xcodeproj`

### Phone Deployment ‚úÖ
- Jackson's iPhone 14 (UDID: 00008110-001A6D303446201E) ‚Äî connected USB, developer mode ON
- Code signing: Jackson Koerner personal team (LS6TK5WQ46), automatic provisioning
- App builds and installs via: `cd ~/projects/V69/ios/App && xcodebuild -project App.xcodeproj -scheme App -destination 'platform=iOS,id=00008110-001A6D303446201E' build` then `ios-deploy --bundle $DERIVED_DATA/Build/Products/Debug-iphoneos/App.app --no-wifi`
- Added Info.plist permissions: location, camera, microphone, photo library
- Safari Web Inspector enabled on phone ‚Äî visible via Safari ‚Üí Develop ‚Üí Jackson's iPhone

### Live Debugging Findings
Console logs from iOS device showed:
- üî¥ Supabase Realtime WebSocket fails on app launch
- ‚ö†Ô∏è IDB hydration times out (3000ms) ‚Äî cascading fallback to localStorage
- ‚ö†Ô∏è Projects, weather, cloud sync ALL time out ‚Äî everything falls back
- App runs almost entirely on localStorage fallbacks
- Deleted report appears on "blocklist" in cloud-recovery

### Bug: Delete One Report ‚Üí Another Goes Blank
- User deleted report B from home screen while report A was open in AI refine
- Report A went blank/loading state
- Root cause: shared `fvp_current_reports` localStorage key has no locking ‚Äî bfcache pages write stale data

---

## 2. Audit Results

Full audit at: `~/projects/V69/docs/AUDIT_IDB_DELETE_FLOW.md`

### Critical Bugs (3)
1. **Cross-page `fvp_current_reports` clobbering** ‚Äî read-modify-write race on shared localStorage map. Delete page writes, then bfcache page overwrites with stale copy. (storage-keys.js:249-270)
2. **IDB connection leak on timeout** ‚Äî after 3s timeout, `onsuccess` can still fire and leak a handle that blocks future DB upgrades. (indexeddb-utils.js)
3. **IDB timeout too aggressive** ‚Äî 3000ms insufficient for iOS Safari after bfcache restore, causing cascading failures across all IDB operations

### High Severity (4)
- No cross-tab/cross-page communication (no BroadcastChannel or storage events)
- Realtime subscriptions become zombies after iOS background
- Realtime DELETE handler doesn't blocklist or clean up fully
- Duplicate delete logic in `confirmCancelReport()` vs `deleteReportFull()`

### Architecture Problem
The three-tier storage (localStorage ‚Üí IDB ‚Üí Supabase) has **no clear ownership rules**. Every page reads/writes to all three tiers independently, creating race conditions. The fallback chain masks failures instead of surfacing them.

---

## 3. Jackson's Design Vision (APPROVED)

### Storage Tier Rules

**localStorage ‚Äî Lightweight pointers ONLY:**
- Current report ID (`fvp_active_report_id`)
- User session / auth token
- UI state (theme, last visited page, sidebar state)
- Device ID
- Deleted report blocklist (small array of IDs)
- NO report content, NO interview data, NO project details

**IndexedDB ‚Äî ALL structured data:**
- Report content (full JSON)
- Interview/draft data
- Project configurations
- Photos (blobs or references)
- Offline queue (pending Supabase syncs)
- This is the LOCAL source of truth

**Supabase ‚Äî Cloud source of truth:**
- Everything syncs up from IDB ‚Üí Supabase
- Real-time subscriptions for multi-device sync
- Supabase ‚Üí IDB for incoming changes
- Background sync, not blocking UI

### Data Flow
```
User Action ‚Üí Write to IDB (immediate) ‚Üí UI updates from IDB
                                       ‚Üí Background sync to Supabase
                                       ‚Üí localStorage gets only the pointer/ID

Supabase Change ‚Üí Realtime subscription ‚Üí Write to IDB ‚Üí UI updates
```

### Delete Flow (clean version)
```
1. Add to blocklist (localStorage ‚Äî small ID array)
2. Delete from IDB (all stores)
3. Update localStorage pointer if it referenced deleted report
4. Background: delete from Supabase (cascade)
5. BroadcastChannel message to other open pages: "report X deleted"
```

---

## 4. What Needs to Happen

### Phase 1: Clean Data Layer (DO THIS FIRST)
1. **Create `js/shared/data-store.js`** ‚Äî single module that owns ALL IDB operations
   - Open/close connection management (with proper timeout + cleanup)
   - CRUD for each store: reports, drafts, photos, projects
   - Connection pooling (reuse handle, don't open fresh every time)
   - Proper `onblocked` handling
   
2. **Create `js/shared/sync-engine.js`** ‚Äî owns Supabase ‚Üî IDB sync
   - Background sync queue (writes pending Supabase ops to IDB queue store)
   - Realtime subscription management with reconnection on visibility change
   - Conflict resolution: timestamp-based, Supabase wins on conflict
   
3. **Refactor localStorage usage** ‚Äî grep every `localStorage.setItem` / `getItem` / `STORAGE_KEYS` usage
   - Move ALL report/project/interview data reads/writes to use data-store.js
   - Keep only pointers and UI state in localStorage
   
4. **Add BroadcastChannel** ‚Äî cross-page communication for delete events

### Phase 2: Fix IDB Reliability
- Increase timeout to 8000ms (or make it adaptive)
- Fix connection leak: cancel pending `onsuccess` after timeout
- Add connection pooling (single handle per session)
- Handle `onblocked` properly (close all, retry)

### Phase 3: Fix Delete Flow
- Single delete function (remove duplicate in persistence.js)
- BroadcastChannel notification to other pages
- No more read-modify-write on shared maps

### Phase 4: Fix Realtime
- Reconnect on `visibilitychange` ‚Üí visible
- Clean up zombie subscriptions
- Handle CHANNEL_ERROR ‚Üí resubscribe

---

## 5. Key Files Reference

| File | Purpose | Status |
|------|---------|--------|
| js/indexeddb-utils.js | IDB operations | Needs rewrite ‚Üí data-store.js |
| js/storage-keys.js | localStorage constants + helpers | Needs cleanup (remove data storage) |
| js/shared/delete-report.js | Delete cascade | Needs refactor |
| js/shared/realtime-sync.js | Supabase realtime | Needs reconnection fixes |
| js/index/cloud-recovery.js | Cloud ‚Üí local recovery | Needs to use IDB not localStorage |
| js/data-layer.js | Data abstraction | Needs to become the real data layer |
| js/interview/persistence.js | Interview save/load | Has duplicate delete, needs refactor |
| js/report/data-loading.js | Report page data | Reads from localStorage, should use IDB |
| js/report/main.js | Report page entry | Has stale visibilitychange handler |

## 6. Supabase Tables

| Table | Purpose |
|-------|---------|
| reports | Report metadata (id, project_id, status, dates) |
| report_data | Report content (JSON) |
| report_backup | Versioned backups |
| interview_backup | Interview state snapshots |
| final_reports | Submitted/finalized reports |
| projects | Project configurations |
| photos | Photo metadata + storage paths |
| ai_submissions | AI refine results |
| user_profiles | User info |
| organizations | Org info |
| user_devices | Device tracking |

## 7. Environment

- **Repo:** ~/projects/V69/ ‚Üí github.com/jacksonkoerner/V69
- **Supabase:** bdqfpemylkqnmeqaoere (service role key in `supabase projects api-keys`)
- **Test account:** simtest@fieldvoice.dev / TestSim2026!
- **Xcode project:** ~/projects/V69/ios/App/App.xcodeproj
- **Phone:** iPhone 14, UDID 00008110-001A6D303446201E, iOS 26.3
- **Safari Web Inspector:** enabled, keep open for live debugging
- **Build:** `npx cap sync ios` then build in Xcode or via xcodebuild

## 8. Rules

- **NO code changes without Jackson's explicit approval**
- **Present plans as numbered proposals first**
- **The web PWA must keep working** ‚Äî iOS wrapper is additive
- **Test on real device** ‚Äî simulator doesn't reproduce iOS-specific IDB bugs
- **Commit after each approved change** ‚Äî small, traceable commits
