# User Profile Cache Key Audit

**Date:** 2026-02-22
**Auditor:** Codex 5.3
**Status:** Audit only — no code changes made

## Scope
Traces all `userProfile` IndexedDB read/write paths and key usage, the lifecycle of `deviceId` vs `authUserId`, concrete mismatch bug scenarios, shim behavior, and fix direction.

## 1) Full Trace: Every `userProfile` IDB Read/Write Path

### Store definitions (canonical key path)
- `userProfile` store is created with key path `deviceId` in legacy IDB utils: `js/indexeddb-utils.js:101-103`
- `userProfile` store is also created with key path `deviceId` in `window.dataStore`: `js/shared/data-store.js:37-38`

### Direct low-level implementations
- `window.idb.saveUserProfile(profile)` writes `store.put(profile)` into `userProfile`: `js/indexeddb-utils.js:268-273`
- `window.idb.getUserProfile(deviceId)` reads `store.get(deviceId)` from `userProfile`: `js/indexeddb-utils.js:292-297`
- `window.dataStore.saveUserProfile(profile)` writes `store.put(profile)` and requires `profile.deviceId`: `js/shared/data-store.js:519-522`
- `window.dataStore.getUserProfile(deviceId)` reads `store.get(deviceId)`: `js/shared/data-store.js:512-515`

### All read call paths to `userProfile`
- `window.dataLayer.loadUserSettings()` computes `cacheKey = authUserId || deviceId` then calls `window.idb.getUserProfile(cacheKey)`: `js/data-layer.js:205, 214, 217`
- Effective read key:
  - Authenticated session: `authUserId` (first choice): `js/data-layer.js:214`
  - No auth session: `deviceId` fallback from localStorage: `js/data-layer.js:214`

### All write call paths to `userProfile`
- Cloud-to-cache path in `loadUserSettings()`:
  - Fetches Supabase row by `auth_user_id`: `js/data-layer.js:239, 242`
  - Normalizes settings and caches via `window.idb.saveUserProfile(settings)`: `js/data-layer.js:256, 258`
  - Normalization sets `deviceId: s.deviceId || s.device_id || ''`: `js/data-layer.js:301`
- Local save path in `saveUserSettings()`:
  - Requires `normalized.deviceId`: `js/data-layer.js:279-280`
  - Writes via `window.idb.saveUserProfile(normalized)`: `js/data-layer.js:285`

### Delete/clear path
- Sign-out clears `userProfile` store with `window.dataStore.clearStore('userProfile')`: `js/auth.js:123, 129`
- `clearStore` executes `store.clear()`: `js/shared/data-store.js:544, 547`

### Shim behavior
- `indexeddb-utils.js` compatibility shim remaps reports/drafts/reportData methods only: `js/indexeddb-utils.js:917-937`
- It does NOT remap `getUserProfile`/`saveUserProfile`; no key normalization is applied

## 2) Lifecycle of `deviceId` and `authUserId`

### `deviceId`
- LocalStorage key: `fvp_device_id`: `js/storage-keys.js:27`
- Generated by `getDeviceId()` using `crypto.randomUUID()` if absent: `js/storage-keys.js:85-91`
- Called in: sign-in (`js/login/main.js:75`), sign-up (`js/login/main.js:216`), auth upsert (`js/auth.js:158`), settings save (`js/settings/main.js:178, 215`)

### `authUserId`
- LocalStorage key: `fvp_auth_user_id`: `js/storage-keys.js:32`
- Source of truth: Supabase session user id (`js/data-layer.js:207-208`)
- Written on sign-in (`js/login/main.js:67`), sign-up (`js/login/main.js:251`), auth upsert (`js/auth.js:179`)
- Cleared on sign-out: `js/auth.js:99-116`

### Can they be the same? **No** — different identity systems (local random UUID vs Supabase Auth UUID)

### Scenario lifecycle
| Event | deviceId | authUserId |
|-------|----------|------------|
| Fresh install | Generated on first `getDeviceId()` call | Not set until login |
| Login | Unchanged | Set from Supabase session |
| Logout | Unchanged (persists) | Cleared from localStorage |
| Re-login (same account) | Unchanged | Re-set (same value) |
| Re-login (different account) | Unchanged | **Different value** |
| Different device | **Different value** | Same (same account) |

## 3) The Bug — Explained Simply

### What happens
1. **Write path:** Profile is saved to IDB keyed by `deviceId` (e.g., `"abc-123"`) → `js/data-layer.js:258, 285, 301`
2. **Read path:** Profile is looked up by `authUserId` (e.g., `"xyz-789"`) → `js/data-layer.js:214, 217`
3. **Result:** IDB returns `undefined` — the data is there but filed under the wrong key

### When it matters
- **Every authenticated page load** — the IDB cache always misses, forcing a cloud fetch
- **Offline** — cache miss with no cloud fallback → `null` → blank profile fields
- **Report pages** — `completedBy`, signature name/title/company all blank (`js/report/form-fields.js:104, 136-138`)

### Shared device risk
- When auth session fails, code falls back to `deviceId` key (`js/data-layer.js:214`)
- If previous user's profile wasn't cleared (sign-out cleanup depends on `window.dataStore` being present: `js/auth.js:123-131`), wrong profile could surface

## 4) `data-store.js` Shim Layer

- Both `getUserProfile()` and `saveUserProfile()` in `data-store.js` are device-keyed: `js/shared/data-store.js:512-523`
- No wrapper normalizes between auth and device identity
- Shim section covers reports/drafts/reportData only: `js/indexeddb-utils.js:917-937`

## 5) Recommended Fix Direction

### Key should be `authUserId` (user-scoped)
- Cloud is already auth-scoped (`auth_user_id`): `js/data-layer.js:242`, `js/settings/main.js:219`
- Profile stores personal data (name, title, company, email, phone): `js/data-layer.js:299-306`
- `device_id` is already described as "informational/write-only": `js/settings/main.js:214-215`

### Migration approach
1. Change IDB store keyPath from `deviceId` to `authUserId` (requires DB version bump)
2. On first authenticated load post-migration: read legacy `deviceId` row, rewrite under `authUserId`
3. Update all `saveUserProfile` callers to include `authUserId` as the key field
4. Update all `getUserProfile` callers to use `authUserId`
5. Keep sign-out `clearStore('userProfile')` for privacy

### Files that need changes
- `js/indexeddb-utils.js` — store creation keyPath + getUserProfile/saveUserProfile signatures
- `js/shared/data-store.js` — store creation keyPath + getUserProfile/saveUserProfile signatures
- `js/data-layer.js` — normalize function + read/write key logic
- `js/settings/main.js` — profile payload construction

## Bottom Line

**Bug confirmed:** Profile writes are device-keyed, reads are auth-keyed. This causes deterministic cache misses on every authenticated page load. Offline, users get blank profile fields. Fix is to standardize on `authUserId` with a one-time migration.
